<!DOCTYPE html>
<html class="light" lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Revisión Batch - Sanitizador Clínico</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#b88a7f",
            "background-light": "#f7f7f6",
            "background-dark": "#1c1716",
            "surface-light": "#ffffff",
            "surface-dark": "#292524",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />

  <!-- Reutilizar estilos de review.html -->
  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #d6d3d1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a29e;
    }

    .highlight-review {
      background-color: #fef3c7;
      color: #92400e;
      border-bottom: 2px solid #f59e0b;
      cursor: pointer;
    }

    .dark .highlight-review {
      background-color: rgba(146, 64, 14, 0.4);
      color: #fcd34d;
      border-bottom: 2px solid #fbbf24;
    }

    .highlight-sub {
      background-color: #d1fae5;
      color: #065f46;
    }

    .dark .highlight-sub {
      background-color: rgba(6, 95, 70, 0.4);
      color: #6ee7b7;
    }

    .highlight-del {
      background-color: rgba(244, 63, 94, 0.2);
      color: #e11d48;
      text-decoration: line-through;
    }

    .dark .highlight-del {
      background-color: rgba(159, 18, 57, 0.4);
      color: #fda4af;
    }

    .highlight-warning {
      background-color: rgba(245, 158, 11, 0.2);
      color: #d97706;
      border-bottom: 2px solid #f59e0b;
      cursor: pointer;
    }

    .dark .highlight-warning {
      background-color: rgba(245, 158, 11, 0.3);
      color: #fbbf24;
      border-bottom: 2px solid #fbbf24;
    }

    .highlight-rel {
      background-color: #e0f2fe;
      color: #075985;
    }

    .dark .highlight-rel {
      background-color: rgba(7, 89, 133, 0.4);
      color: #7dd3fc;
    }

    @keyframes highlight-pulse {
      0%, 100% { background-color: rgba(251, 191, 36, 0.3); }
      50% { background-color: rgba(251, 191, 36, 0.6); }
    }

    .selected-entity {
      animation: highlight-pulse 1.5s ease-in-out;
    }

    body {
      font-family: 'Inter', sans-serif;
    }

    .batch-nav-item {
      transition: all 0.2s ease;
    }

    .batch-nav-item.current {
      border-left: 4px solid #b88a7f;
      background-color: rgba(184, 138, 127, 0.1);
    }

    .batch-nav-item:hover {
      background-color: rgba(184, 138, 127, 0.05);
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-stone-900 dark:text-stone-100 overflow-hidden">
  <!-- Header de navegación batch -->
  <header class="h-16 bg-surface-light dark:bg-surface-dark border-b border-stone-200 dark:border-stone-700 flex items-center justify-between px-6">
    <div class="flex items-center gap-4">
      <a href="./batch.html" class="text-stone-500 hover:text-stone-700 dark:text-stone-400 dark:hover:text-stone-200">
        <span class="material-symbols-outlined">arrow_back</span>
      </a>
      <div>
        <h2 class="text-lg font-bold">Revisión Batch</h2>
        <p class="text-xs text-stone-500 dark:text-stone-400">
          Documento <span id="current-doc-number">1</span> de <span id="total-docs">0</span>
        </p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="prev-doc-btn" class="px-4 py-2 text-sm font-medium bg-stone-200 dark:bg-stone-700 hover:bg-stone-300 dark:hover:bg-stone-600 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <span class="material-symbols-outlined text-sm">arrow_back</span>
        Anterior
      </button>
      <button id="next-doc-btn" class="px-4 py-2 text-sm font-medium bg-primary hover:bg-primary/90 text-white rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        Siguiente
        <span class="material-symbols-outlined text-sm">arrow_forward</span>
      </button>
      <button id="export-batch-btn" class="px-4 py-2 text-sm font-medium bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">download</span>
        Exportar Batch
      </button>
    </div>
  </header>

  <!-- Contenedor principal con sidebar -->
  <div class="flex h-[calc(100vh-4rem)]">
    <!-- Sidebar de navegación de documentos -->
    <aside class="w-64 bg-surface-light dark:bg-surface-dark border-r border-stone-200 dark:border-stone-700 overflow-y-auto">
      <div class="p-4">
        <h3 class="text-sm font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wide mb-3">Documentos del Batch</h3>
        <ul id="batch-doc-list" class="space-y-1">
          <!-- Se llenarán dinámicamente -->
        </ul>
      </div>
    </aside>

    <!-- Área de revisión (iframe que carga review.html adaptado) -->
    <main id="review-main-area" class="flex-1 overflow-hidden">
      <!-- Aquí se renderizará la UI de review.html pero inline -->
      <div class="h-full flex">
        <!-- Panel izquierdo: Texto procesado -->
        <div class="flex-1 flex flex-col overflow-hidden bg-background-light dark:bg-background-dark">
          <div id="main-text-scroll-area"
            class="flex-1 overflow-y-auto p-6 leading-relaxed text-base text-stone-900 dark:text-stone-100 font-serif">
            <!-- Texto procesado se renderiza aquí -->
          </div>

          <!-- Action Bar (copiado de review.html) -->
          <div id="review-action-bar"
            class="hidden h-24 bg-gradient-to-r from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/30 border-t-2 border-amber-400 dark:border-amber-600 px-6 py-4 flex items-center justify-between shadow-lg">
            <div class="flex-1">
              <p class="text-xs font-bold text-amber-800 dark:text-amber-300 uppercase tracking-wide mb-1">Entidad
                Seleccionada</p>
              <div class="flex items-center gap-2">
                <span id="action-bar-title" class="text-lg font-bold text-stone-900 dark:text-stone-100"></span>
                <span id="action-bar-type"
                  class="text-xs px-2 py-1 bg-amber-200 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-full"></span>
              </div>
            </div>
            <div class="flex gap-3">
              <button id="accept-btn"
                class="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition-colors shadow-md">
                <span class="material-symbols-outlined text-[18px]">check</span> Aceptar
              </button>
              <button id="ignore-btn"
                class="flex items-center gap-2 px-4 py-2 bg-stone-600 hover:bg-stone-700 text-white rounded-lg text-sm font-bold transition-colors shadow-md">
                <span class="material-symbols-outlined text-[18px]">undo</span> Restaurar
              </button>
              <button id="modify-btn"
                class="flex items-center gap-2 px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg text-sm font-bold transition-colors shadow-md">
                <span class="material-symbols-outlined text-[18px]">edit</span> Modificar
              </button>
            </div>
          </div>
        </div>

        <!-- Panel derecho: Entidades pendientes -->
        <div class="w-[400px] bg-surface-light dark:bg-surface-dark border-l border-stone-200 dark:border-stone-700 flex flex-col">
          <!-- Header del panel -->
          <div class="p-4 border-b border-stone-200 dark:border-stone-700">
            <h2 class="text-lg font-bold text-stone-900 dark:text-stone-100 mb-2">Entidades Detectadas</h2>
            <div class="flex items-center justify-between text-sm">
              <span class="text-stone-600 dark:text-stone-400">Progreso de Revisión</span>
              <span class="font-bold text-primary" id="review-percentage">0%</span>
            </div>
            <div class="mt-2 w-full bg-stone-200 dark:bg-stone-700 rounded-full h-2">
              <div id="review-progress-bar" class="bg-primary h-full rounded-full transition-all duration-300"
                style="width: 0%"></div>
            </div>
            <p class="text-xs text-stone-500 dark:text-stone-400 mt-1">
              <span id="reviewed-count">0</span>/<span id="total-count">0</span> revisadas
            </p>
          </div>

          <!-- Lista de entidades -->
          <div class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- Las entidades se renderizan aquí -->
          </div>

          <!-- Footer con botones de exportación individual -->
          <div class="p-4 border-t border-stone-200 dark:border-stone-700 space-y-2">
            <button id="copy-btn"
              class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-stone-700 hover:bg-stone-800 text-white rounded-lg text-sm font-bold transition-colors">
              <span class="material-symbols-outlined text-[20px]">content_copy</span>
              <span class="text-sm font-medium">Copiar Texto</span>
            </button>
            <button id="pdf-btn"
              class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm font-bold transition-colors">
              <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
              <span class="text-sm font-medium">Exportar PDF</span>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de edición (copiado de review.html) -->
  <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center">
    <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-2xl max-w-md w-full mx-4 animate-scale-in">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-stone-200 dark:border-stone-700">
        <h3 class="text-lg font-bold text-stone-900 dark:text-stone-100">Modificar Entidad</h3>
        <button id="modal-close-btn" class="text-stone-400 hover:text-stone-600 dark:hover:text-stone-200">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4">
        <!-- Original -->
        <div>
          <label class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Texto Original</label>
          <div id="modal-original-text"
            class="p-3 bg-stone-100 dark:bg-stone-800 rounded-lg text-stone-900 dark:text-stone-100 font-mono text-sm">
          </div>
        </div>

        <!-- Edit -->
        <div>
          <label for="modal-edit-input" class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
            Editar Transformación
          </label>
          <input type="text" id="modal-edit-input"
            class="w-full px-4 py-2 border border-stone-300 dark:border-stone-600 rounded-lg bg-white dark:bg-stone-900 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>

        <!-- Notes -->
        <div>
          <label for="modal-notes-input" class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
            Notas (Opcional)
          </label>
          <textarea id="modal-notes-input" rows="3"
            class="w-full px-4 py-2 border border-stone-300 dark:border-stone-600 rounded-lg bg-white dark:bg-stone-900 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="Añade notas sobre por qué modificaste esta entidad..."></textarea>
        </div>

        <p class="text-xs text-stone-500 dark:text-stone-400">
          Las modificaciones quedarán registradas en el informe PDF para trazabilidad.
        </p>
      </div>

      <!-- Footer -->
      <div class="flex gap-3 p-6 border-t border-stone-200 dark:border-stone-700">
        <button id="modal-cancel-btn"
          class="flex-1 px-4 py-2 bg-stone-200 dark:bg-stone-700 hover:bg-stone-300 dark:hover:bg-stone-600 text-stone-900 dark:text-stone-100 rounded-lg font-medium">
          Cancelar
        </button>
        <button id="modal-delete-btn"
          class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">
          Eliminar
        </button>
        <button id="modal-save-btn"
          class="flex-1 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Tooltip de selección manual -->
  <div id="manual-selection-tooltip"
    class="hidden fixed bg-stone-900 dark:bg-stone-100 text-white dark:text-stone-900 px-3 py-2 rounded-lg shadow-xl z-50 flex gap-2">
    <button class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs font-bold" data-type="NOMBRE">
      Nombre
    </button>
    <button class="px-3 py-1 bg-sky-600 hover:bg-sky-700 rounded text-xs font-bold" data-type="FECHA">
      Fecha
    </button>
    <button class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 rounded text-xs font-bold" data-type="UBICACION">
      Ubicación
    </button>
    <button class="px-3 py-1 bg-rose-600 hover:bg-rose-700 rounded text-xs font-bold" data-type="IDENTIFICADOR">
      ID
    </button>
  </div>

  <!-- Scripts -->
  <script src="./js/standalone-processor.js"></script>
  <script src="./js/batch-exporter.js"></script>
  <script src="./js/review-functions.js"></script>
  <script>
    // Variable global para resultados
    let processingResult = null;
    let batchData = null;
    let currentDocIndex = 0;
    let documents = [];

    document.addEventListener('DOMContentLoaded', () => {
      // Cargar datos del batch
      const batchJSON = localStorage.getItem('batchResults');

      if (!batchJSON) {
        alert('No hay documentos para revisar. Redirigiendo a batch.html...');
        window.location.href = './batch.html';
        return;
      }

      batchData = JSON.parse(batchJSON);
      documents = batchData.documents;

      if (!documents || documents.length === 0) {
        alert('No hay documentos en el batch');
        window.location.href = './batch.html';
        return;
      }

      // Actualizar total de documentos
      document.getElementById('total-docs').textContent = documents.length;

      // Renderizar lista de documentos
      renderBatchDocList();

      // Cargar primer documento
      loadDocument(0);

      // Navegación
      document.getElementById('prev-doc-btn').addEventListener('click', () => {
        if (currentDocIndex > 0) {
          saveCurrentDocState();
          loadDocument(currentDocIndex - 1);
        }
      });

      document.getElementById('next-doc-btn').addEventListener('click', () => {
        if (currentDocIndex < documents.length - 1) {
          saveCurrentDocState();
          loadDocument(currentDocIndex + 1);
        } else {
          alert('Este es el último documento del batch');
        }
      });

      // Exportar batch
      document.getElementById('export-batch-btn').addEventListener('click', () => {
        exportBatch();
      });

      // Copiar y PDF individual (copiar lógica de review.html)
      setupExportButtons();

      // Inicializar lógica de revisión (copiar de review.html)
      initializeReviewLogic();
    });

    function renderBatchDocList() {
      const list = document.getElementById('batch-doc-list');
      list.innerHTML = '';

      documents.forEach((doc, idx) => {
        const li = document.createElement('li');
        li.className = 'batch-nav-item px-3 py-2 rounded-lg cursor-pointer text-sm';
        if (idx === currentDocIndex) {
          li.classList.add('current');
        }

        const isReviewed = doc.reviewed || false;

        li.innerHTML = `
          <div class="font-medium text-stone-900 dark:text-stone-100 mb-1 truncate">${doc.name}</div>
          <div class="flex items-center gap-2 text-xs">
            <span class="${isReviewed ? 'text-emerald-600' : 'text-amber-600'}">
              ${isReviewed ? '✓ Revisado' : '⏳ Pendiente'}
            </span>
            <span class="text-stone-500">${doc.result.stats.totalEntities} entidades</span>
          </div>
        `;

        li.addEventListener('click', () => {
          if (idx !== currentDocIndex) {
            saveCurrentDocState();
            loadDocument(idx);
          }
        });

        list.appendChild(li);
      });
    }

    function loadDocument(index) {
      currentDocIndex = index;
      const doc = documents[index];

      // Actualizar número de documento
      document.getElementById('current-doc-number').textContent = index + 1;

      // Actualizar botones de navegación
      document.getElementById('prev-doc-btn').disabled = index === 0;
      document.getElementById('next-doc-btn').disabled = index === documents.length - 1;

      // Actualizar sidebar
      renderBatchDocList();

      // Cargar resultado para review
      processingResult = doc.result;

      // Renderizar (copiar funciones de review.html)
      renderMainText(processingResult);
      renderSidePanel(processingResult);
      updateReviewCounter();
    }

    function saveCurrentDocState() {
      // Guardar estado de revisión del documento actual
      documents[currentDocIndex].reviewed = true;
      documents[currentDocIndex].result = processingResult;

      // Actualizar localStorage
      batchData.documents = documents;
      localStorage.setItem('batchResults', JSON.stringify(batchData));
    }

    function exportBatch() {
      saveCurrentDocState();

      const format = batchData.exportFormat || 'pdf-consolidated';

      switch (format) {
        case 'pdf-consolidated':
          window.BatchExporter.exportConsolidatedPDF(documents, batchData.mapper);
          break;
        case 'pdf-individual':
          window.BatchExporter.exportIndividualPDFs(documents);
          break;
        case 'excel':
          window.BatchExporter.exportExcel(documents);
          break;
      }
    }

    // ===== FUNCIONES COPIADAS DE REVIEW.HTML =====
    // (Copiar las funciones críticas de review.html aquí)
  </script>

  <!-- Incluir script de funciones de revisión -->
  <script>
    // Copiar funciones de review.html: renderMainText, renderSidePanel, updateReviewCounter, setupExportButtons, initializeReviewLogic
    // Por brevedad, voy a agregar las funciones esenciales...
  </script>
</body>

</html>

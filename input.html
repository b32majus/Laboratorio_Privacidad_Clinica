<!DOCTYPE html>

<html class="light" lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>App Principal - Entrada de Texto</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- PDF.js para lectura de PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js para lectura de DOCX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- Tailwind Config -->
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#b88a7f",
            "primary-dark": "#966a60",
            "background-light": "#f7f7f6",
            "background-dark": "#1c1716",
            "surface-light": "#ffffff",
            "surface-dark": "#2a2524",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
          boxShadow: {
            'soft': '0 4px 20px -2px rgba(184, 138, 127, 0.1)',
            'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
          }
        },
      },
    }
  </script>
  <style>
    /* Custom scrollbar for textarea to maintain clean aesthetic */
    textarea::-webkit-scrollbar {
      width: 8px;
    }

    textarea::-webkit-scrollbar-track {
      background: transparent;
    }

    textarea::-webkit-scrollbar-thumb {
      background-color: #d6d3d1;
      border-radius: 20px;
      border: 3px solid transparent;
      background-clip: content-box;
    }

    .dark textarea::-webkit-scrollbar-thumb {
      background-color: #57534e;
    }
  </style>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
</head>

<body
  class="bg-background-light dark:bg-background-dark font-display text-stone-900 dark:text-stone-100 antialiased min-h-screen flex flex-col selection:bg-primary/30 selection:text-primary-dark">
  <!-- Top App Bar -->
  <header
    class="flex items-center justify-between px-4 pt-6 pb-2 bg-surface-light dark:bg-surface-dark shrink-0 z-10 border-b border-stone-200 dark:border-stone-800">
    <div class="flex items-center gap-3">
      <a href="app.html" class="text-stone-500 hover:text-primary transition-colors" title="Volver al inicio">
        <span class="material-symbols-outlined">home</span>
      </a>
      <h1
        class="text-[#171312] dark:text-stone-100 text-lg font-bold leading-tight tracking-tight flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">security</span>
        Laboratorio de Privacidad
      </h1>
    </div>
  </header>
  <!-- Premium Batch Banner -->
  <div
    class="px-4 py-3 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-y border-amber-200 dark:border-amber-800">
    <div class="max-w-lg mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-amber-600 dark:text-amber-400 text-2xl">batch_prediction</span>
        <div>
          <p class="text-sm font-bold text-stone-900 dark:text-stone-100">¿Necesitas procesar múltiples documentos?</p>
          <p class="text-xs text-stone-600 dark:text-stone-400">Modo Batch Premium disponible</p>
        </div>
      </div>
      <a href="./batch.html"
        class="px-4 py-2 bg-primary hover:bg-primary-dark text-white text-sm font-bold rounded-lg shadow-md transition-all flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">upgrade</span>
        Activar
      </a>
    </div>
  </div>

  <!-- Main Content Area with Sidebar -->
  <div class="flex-1 flex gap-8 px-4 py-8 max-w-7xl mx-auto w-full overflow-hidden mt-6">
    <!-- Examples Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col gap-3 pt-2">
      <div
        class="bg-surface-light dark:bg-surface-dark rounded-xl border border-stone-200 dark:border-stone-800 p-4 shadow-sm">
        <h3
          class="text-stone-900 dark:text-stone-100 text-sm font-bold mb-4 flex items-center gap-2 uppercase tracking-wider opacity-80">
          <span class="material-symbols-outlined text-primary text-lg">lightbulb</span>
          Ejemplos de Uso
        </h3>
        <div class="flex flex-col gap-3">
          <!-- Ejemplo 1: Urgencias -->
          <button
            class="example-card text-left p-3 rounded-lg border border-stone-200 dark:border-stone-700 hover:border-primary/50 hover:bg-stone-50 dark:hover:bg-stone-800 transition-all group"
            data-example="urgencias">
            <div class="flex items-start gap-3">
              <div
                class="p-2 rounded-md bg-stone-100 dark:bg-stone-800 text-primary-dark group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-xl">emergency</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4
                  class="font-bold text-sm text-stone-900 dark:text-stone-100 group-hover:text-primary transition-colors">
                  Consulta de Urgencias</h4>
                <p class="text-xs text-stone-500 dark:text-stone-400 mt-1 line-clamp-2 leading-relaxed">Paciente
                  derivado con dolor abdominal...</p>
              </div>
            </div>
          </button>
          <!-- Ejemplo 2: Quirúrgico -->
          <button
            class="example-card text-left p-3 rounded-lg border border-stone-200 dark:border-stone-700 hover:border-primary/50 hover:bg-stone-50 dark:hover:bg-stone-800 transition-all group"
            data-example="quirurgico">
            <div class="flex items-start gap-3">
              <div
                class="p-2 rounded-md bg-stone-100 dark:bg-stone-800 text-primary-dark group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-xl">surgical</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4
                  class="font-bold text-sm text-stone-900 dark:text-stone-100 group-hover:text-primary transition-colors">
                  Informe Quirúrgico</h4>
                <p class="text-xs text-stone-500 dark:text-stone-400 mt-1 line-clamp-2 leading-relaxed">Intervención
                  realizada por especialista...</p>
              </div>
            </div>
          </button>
          <!-- Ejemplo 3: Historia Clínica -->
          <button
            class="example-card text-left p-3 rounded-lg border border-stone-200 dark:border-stone-700 hover:border-primary/50 hover:bg-stone-50 dark:hover:bg-stone-800 transition-all group"
            data-example="historia">
            <div class="flex items-start gap-3">
              <div
                class="p-2 rounded-md bg-stone-100 dark:bg-stone-800 text-primary-dark group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-xl">description</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4
                  class="font-bold text-sm text-stone-900 dark:text-stone-100 group-hover:text-primary transition-colors">
                  Historia Clínica</h4>
                <p class="text-xs text-stone-500 dark:text-stone-400 mt-1 line-clamp-2 leading-relaxed">Paciente con
                  antecedentes médicos...</p>
              </div>
            </div>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0">
      <!-- Headline & Instructions -->
      <div class="pb-4 shrink-0">
        <h2 class="text-[#171312] dark:text-white text-[28px] font-bold leading-tight tracking-tight">
          Entrada de Texto
        </h2>
        <!-- Privacy Badge -->
        <div class="flex items-center gap-1.5 mt-2 text-[#7f6b66] dark:text-[#ccb0aa] text-sm font-medium">
          <span class="material-symbols-outlined text-primary" style="font-size: 18px;">lock</span>
          <p>Procesamiento 100% Local. Datos seguros.</p>
        </div>
      </div>
      <!-- Input Field (Canvas) -->
      <div
        class="relative flex flex-col min-h-[300px] flex-1 bg-surface-light dark:bg-surface-dark rounded-xl shadow-soft border border-stone-200 dark:border-stone-800 transition-all focus-within:ring-2 focus-within:ring-primary/50 focus-within:border-primary overflow-hidden group">
        <label class="sr-only" for="clinical-text">Texto Clínico</label>
        <textarea
          class="flex-1 w-full h-full resize-none bg-transparent border-0 focus:ring-0 text-[#171312] dark:text-stone-200 p-5 text-base font-normal leading-relaxed placeholder:text-[#a8a29e] dark:placeholder:text-stone-600 appearance-none"
          id="clinical-text" placeholder="Pegue aquí el texto clínico o seleccione un ejemplo de la izquierda..."
          spellcheck="false"></textarea>
        <!-- Floating Actions -->
        <div
          class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-200 flex gap-2">
          <button id="upload-btn"
            class="flex items-center gap-1.5 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 text-stone-600 dark:text-stone-300 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors border border-stone-200 dark:border-stone-600">
            <span class="material-symbols-outlined" style="font-size: 16px;">upload_file</span>
            Cargar archivo
          </button>
          <button id="paste-btn"
            class="flex items-center gap-1.5 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 text-stone-600 dark:text-stone-300 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors border border-stone-200 dark:border-stone-600">
            <span class="material-symbols-outlined" style="font-size: 16px;">content_paste</span>
            Pegar
          </button>
        </div>
        <!-- Input file oculto -->
        <input type="file" id="file-input" accept=".txt,.pdf,.doc,.docx" class="hidden" />
      </div>
      <!-- Action Bar -->
      <div class="pt-4 shrink-0">
        <button id="process-btn"
          class="relative w-full overflow-hidden rounded-xl h-14 bg-primary hover:bg-primary-dark active:scale-[0.99] transition-all duration-200 text-white shadow-lg shadow-primary/25 group">
          <div
            class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
          </div>
          <div class="relative flex items-center justify-center gap-2">
            <span class="text-base font-bold tracking-wide">Procesar Texto</span>
            <span class="material-symbols-outlined animate-pulse" style="font-size: 20px;">auto_fix_high</span>
          </div>
        </button>
        <!-- Secondary/Help Text -->
        <p class="text-center text-xs text-stone-400 dark:text-stone-600 mt-3 font-medium">
          Seudonimización automática potenciada por IA
        </p>
      </div>
    </main>
  </div>
  <script>
    // Configurar PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const processBtn = document.getElementById('process-btn');
      const textArea = document.getElementById('clinical-text');

      if (!processBtn || !textArea) {
        console.error('Required elements not found');
        return;
      }

      processBtn.addEventListener('click', () => {
        const text = textArea.value;

        if (!text.trim()) {
          alert('Por favor, introduzca un texto clínico para procesar.');
          return;
        }

        console.log('Saving text to localStorage:', text.substring(0, 50) + '...');

        // Guardar en Local Storage
        localStorage.setItem('clinicalText', text);

        // Navegar a la página de revisión
        console.log('Navigating to review.html');
        window.location.href = './review.html';
      });

      // Botón Pegar
      const pasteBtn = document.getElementById('paste-btn');
      if (pasteBtn) {
        pasteBtn.addEventListener('click', async () => {
          try {
            const clipboardText = await navigator.clipboard.readText();
            textArea.value = clipboardText;
            textArea.focus();
          } catch (err) {
            console.error('Error al pegar:', err);
            alert('No se pudo acceder al portapapeles. Use Ctrl+V.');
          }
        });
      }

      // Botón Cargar Archivo
      const uploadBtn = document.getElementById('upload-btn');
      const fileInput = document.getElementById('file-input');

      if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => {
          fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const fileName = file.name.toLowerCase();
          const extension = fileName.split('.').pop();

          try {
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="material-symbols-outlined animate-spin" style="font-size: 16px;">sync</span> Cargando...';

            let text = '';

            if (extension === 'txt') {
              // Leer archivo TXT
              text = await file.text();
            } else if (extension === 'pdf') {
              // Leer archivo PDF
              text = await readPDF(file);
            } else if (extension === 'doc' || extension === 'docx') {
              // Leer archivo DOCX
              text = await readDOCX(file);
            } else {
              alert('Formato no soportado. Use TXT, PDF o DOCX.');
              return;
            }

            textArea.value = text;
            textArea.focus();

            // Restaurar botón
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">upload_file</span> Cargar archivo';

          } catch (err) {
            console.error('Error al cargar archivo:', err);
            alert('Error al leer el archivo: ' + err.message);
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">upload_file</span> Cargar archivo';
          }

          // Limpiar input
          fileInput.value = '';
        });
      }

      // Función para leer PDFs
      async function readPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n\n';
        }

        return fullText.trim();
      }

      // Función para leer DOCX
      async function readDOCX(file) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        return result.value;
      }

      // Ejemplos - Sidebar Cards
      const exampleCards = document.querySelectorAll('.example-card');
      const ejemplos = {
        urgencias: 'Paciente esudardo garcia, derivado a hospital virgen del rocío con 54 años y DNI 30970148B por dolor abdominal. Reside en Calle Mayor 123, Sevilla.',
        quirurgico: 'Intervención realizada el 15/03/2024 por Dr. Juan Martínez en paciente con 67 años. Contacto: 654321987.',
        historia: 'Paciente Carmen Rodríguez con 45 años. Última consulta 20/12/2023. Teléfono: 612345678.'
      };

      exampleCards.forEach(card => {
        card.addEventListener('click', () => {
          const exampleType = card.dataset.example;
          if (ejemplos[exampleType]) {
            textArea.value = ejemplos[exampleType];
            textArea.focus();

            // Visual feedback
            exampleCards.forEach(c => c.classList.remove('ring-2', 'ring-primary'));
            card.classList.add('ring-2', 'ring-primary');
          }
        });
      });
    });
  </script>
  <footer
    class="bg-white dark:bg-stone-900 border-t border-stone-200 dark:border-stone-800 py-4 px-6 text-center text-sm text-stone-500 dark:text-stone-400 mt-auto">
    <div class="flex gap-4 justify-center">
      <a href="guia.html" class="hover:text-primary transition">Guía</a>
      <a href="terminos.html" class="hover:text-primary transition">Términos</a>
      <a href="index.html" class="hover:text-primary transition">Inicio</a>
    </div>
  </footer>
</body>

</html>